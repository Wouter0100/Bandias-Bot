var bandiasTabId = null;

chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
	if (request.type == 'openBandiasTab'){

		if (bandiasTabId == null) {
			var createProperties = {};
			createProperties.url = 'http://bandias.nl/';

			chrome.tabs.create(createProperties, function(tab) {
				bandiasTabId = tab.id;
			});
		} else {
			var updateProperties = {};
			updateProperties.active = true;

			chrome.tabs.update(bandiasTabId, updateProperties);
		}

		return true;
	} else if (request.type == 'pageSource') {
		$(request.source);

		console.log($('#div_popup_error').html());
	}
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
	if (bandiasTabId == tabId) {
		chrome.tabs.executeScript(tabId, {
			code: 'chrome.runtime.sendMessage({ type: "pageSource", source: document.documentElement.outerHTML });'
		});

		chrome.tabs.executeScript(tabId, {
			code: 'document.title = "Bandias Bot";'
		});
	}
});

chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
	if (tabId == bandiasTabId) {
		bandiasTabId = null;	
	}
});
